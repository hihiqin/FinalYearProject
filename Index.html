<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset = "UTF-8">
    <meta name = "viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tool</title>
    <style> 
    /* CSS begin */
       body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-size: cover; /* 覆盖整个页面 */
    background-repeat: no-repeat; /* 防止背景图重复 */
    background-attachment: fixed; /* 背景图固定，不随滚动条滚动 */
}

.top-nav {
    display: flex;
    justify-content: start;
    background-color: white;
    padding: 10px;
    position: fixed;
    top: 0;
    width: 100%;
    height: 60px; /* Adjust based on actual height of your nav bar */
    z-index: 100; /* Ensures the top nav stays above other content */
}

.logo {
    height: 50px; /* Adjust the size as needed */
    margin-right: 20px;
}
.nav-title {
    font-size: 20px;
    font-weight: bold;
    margin: auto 20px; /* Centers the title and adds horizontal space */
}

.nav-button {
    margin-left: 10px;
    padding: 10px 20px;
}

.sidebar {
    width: 200px;
    position: fixed;
    left: 0;
    top: 60px; /* Adjust to be the same as the height of the top nav */
    bottom: 0;
    padding: 20px;
    overflow-y: auto; /* Adds scroll to sidebar if content is too long */
    background-size: cover; /* This will cover the entire sidebar */
    background-repeat: no-repeat; /* Prevents the image from repeating */
    background:#ffffff;
}
 


.button-like {
    display: inline-block;
    padding: 10px 15px;
    margin: 5px;
    background-color: #007bff; /* Button color */
    color: white;
    text-align: center;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.button-like:hover {
    background-color: #0056b3; /* Color when hovered */
}

.attendance h2 {
    font-size: 16px;
    margin-bottom: 5px;
}

.attendance ul {
    list-style: none;  
    padding: 0;
}

.attendance li {
    margin-bottom: 5px;
}

/* Adjust the main content area to avoid being hidden by the sidebar */
main {
    margin-left: 200px; /* Same as the width of the sidebar */
    margin-top: 60px; /* Same as the height of the top nav */
    padding: 20px;
}
/* ... [rest of your CSS] ... */

.accordion-button {
    background-color: #f0f0f0;
    color: black;
    cursor: pointer;
    padding: 18px;
    width: 100%;
    border: none;
    text-align: left;
    outline: none;
    font-size: 15px;
    transition: 0.4s;
}
/* ... [rest of your CSS] ... */

.accordion-button .arrow {
    font-size: 12px; /* Adjust as needed */
    margin-left: 5px;
}


.panel {
    padding: 0 18px;
    display: none;
    overflow: hidden;
}
.csv-textarea-container {
    display:flex;
    flex-direction: column; /* Stack textareas vertically */
    align-items: center; /* Center textareas horizontally */
    gap: 50px; /* Space between textareas */
}

#csvTextarea2 {
    width: 80%; /* Adjust as needed */
    height: 300px; /* Adjust as needed */
    padding: 10px;
    margin: 10px;   
    font-family: monospace;
    overflow: auto; 
    border: 1px solid #ccc; 
    border-radius: 4px;
    resize: vertical;
}


#csvAttendancePercentageResult {
    width: 80%; /* Adjust as needed */
    height: 300px; /* Adjust as needed */
    padding: 10px;
    margin: 10px;   
    font-family: monospace;
    overflow: auto;
    border: 1px solid #ccc; 
    border-radius: 4px;
    resize: vertical;
}
#csvDisplayArea, #scoreDisplayArea, #csvAttendancePercentageDisplay,#csvhiddenDisplay{
    width: 80%; /* Adjust as needed */
    height: 300px; /* Adjust as needed */
    padding: 10px;
    margin: 10px;
    font-family: monospace;
    overflow: auto; 
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: vertical;
}

.main-content,
.calculate-average-score {
    display: none;
}
.calculategroupattendance {
    display: none;
}
.CalculateHiddenLab {
    display: none;
}

#classListArea, #labInfoArea,#classListArea2,#labInfoArea2 {
    width: 300px; 
    height: 300px; 
    padding: 10px;
    margin: 10px;
    font-family: monospace;
    overflow: auto; 
    border: 1px solid #ccc; 
    border-radius: 4px;
    resize: vertical;
}

#avgScoreDisplayArea
{
    width: 600px; /* Adjust as needed */
    height: 300px; /* Adjust as needed */
    padding: 10px;
    margin: 10px;
    font-family: monospace;
    overflow: auto;
    border: 1px solid #ccc; 
    border-radius: 4px;
    resize: vertical;
}
#csvhiddenDisplay {
    width: 600px; /* Adjust as needed */
    height: 300px; /* Adjust as needed */
    padding: 10px;
    margin: 10px;
    font-family: monospace;
    overflow: auto; /* scrollbar */
    border: 1px solid #ccc; 
    border-radius: 4px;
    resize: vertical;
}
.row {
    display: flex;
}

.custom-file-upload {
    display: inline-block;
    padding: 6px 12px;
    cursor: pointer;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 4px;
}
.custom-file-upload2 {
    display: inline-block;
    padding: 6px 12px;
    cursor: pointer;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 4px;

}


            /* CSS end */
    </style>
</head>
<body>
    <header>
        <nav class="top-nav">
            <img src="https://res.cloudinary.com/ddnhkzyd5/image/upload/v1711235833/logo_iifiiz.png" alt="Logo">

            <div class="nav-title">Attendance Tool</div>
        </nav>
    </header>
</head>
<body>
    <!-- HTML BEGIN -->
<aside class="sidebar">
        <div class="accordion">
            <button class="accordion-button" onclick="toggleAccordion('section1')" data-section="section1">
                Attendance Check During the Semester <span class="arrow">►</span>
            </button>
            
            <div class="panel" id="section1">
            </button> <p class="button-like" id="showMainContent">Students who did lab late/excuse/absent</p>
                <p class="button-like" id="showMainContent2">Percentages for 100% attendance of each group</p>
                <p class="button-like" id="toggleScoreArea">Each student lab average result from weekly lab</p>
                <p class="button-like"id="NotHiddenLab">Student who didn't entirely complete the hidden question</p>

            </div>
        </div>
        <div class="accordion">
            <button class="accordion-button" onclick="toggleAccordion('section2')" data-section="section2">
                Attendance Check at the End of Semester <span class="arrow">►</span>
            </button>
            <div class="panel" id="section2">
                <p class="button-like">Wait for further exploration......</p>
                <p class="button-like">Wait for further exploration......</p>
                <p class="button-like">Wait for further exploration......</p>
                <p class="button-like">Wait for further exploration......</p>
                <p class="button-like">Wait for further exploration......</p>
            </div>            
        </div>
        
    </aside>
    
    <main class="main-content">
        <!-- <textarea id="csvTextarea1" rows="10" cols="50">CSV Content 1</textarea> -->
        <div id="csvDisplayArea">CSV Content for Student Attendance</div>
        <input type="file" id="csvFileInput" accept=".csv">
        <button type="button" onclick="loadCSV()">Upload CSV</button>
        <button class="button" onclick="downloadCSV()">Download the generated File</button>
        <div id="csvTextarea2" rows="10" cols="50">CSV Content For the Attendanc Result</div>

    </main>

    <main class="calculate-average-score">
        <div class="row">
            <div class="inputArea">
                <input type="file" accept=".csv" id = "uploadClassList"  hidden>
                <label for="uploadClassList" class="custom-file-upload">Input ClassCSV</label>
                <div id="classListArea">Classlist Display Area</div>
            </div>
            <div class="inputArea">
                <input type="file" accept=".csv" id = "uploadLabInfo"  hidden>
                <label for="uploadLabInfo" class="custom-file-upload">Input LabCSV</label>
                <div id="labInfoArea">Laf Info Area</div>
            </div>
        </div>
        <button id="calculateAvgScore">Calculate Average</button>
            <label>Select the hidden Labs Rate:</label>
            <input type="radio" id="multiplyBy1.5" name="multiplier" value="1.5" checked>
            <label for="multiplyBy1.5">X1.5</label>        
            <input type="radio" id="multiplyBy2" name="multiplier" value="2">
            <label for="multiplyBy2">X2</label>
            <input type="radio" id="multiplyBy2.5" name="multiplier" value="2.5">
            <label for="multiplyBy2">X2.5</label>
            <input type="radio" id="multiplyBy3" name="multiplier" value="3">
            <label for="multiplyBy2">X3</label>
        <!-- Div to display the breakdown -->
        <div id="avgScoreDisplayArea">Avg Score Display</div>
        <button id="downloadaverageResult">Download the generated file</button>
    </main>
   

    <main class="CalculateHiddenLab">
        <div class="row">
            <div class="inputArea2">
                <input type="file" accept=".csv" id = "uploadClassList2"  hidden>
                <label for="uploadClassList2" class="custom-file-upload2">Input ClassCSV</label>
                <div id="classListArea2">Classlist Display Area</div>
            </div>
            <div class="inputArea2">
                <input type="file" accept=".csv" id = "uploadLabInfo2"  hidden>
                <label for="uploadLabInfo2" class="custom-file-upload2">Input LabCSV</label>
                <div id="labInfoArea2">Laf Info Area</div>
            </div>
        </div>
        <button id="calculateHiddenlab">Calculate hidden lab</button>
        <button id="downloadHiddenlab">Download the generated file</button>
        <div id="csvhiddenDisplay">Student Missed Hidden Labs Display</div>

    </main>

    
    <main class="calculategroupattendance">
        <div id="percentagesContent">
            <div id="csvAttendancePercentageDisplay">CSV Content for Attendance Percentage</div>
            <input type="file" id="csvAttendancePercentageInput" accept=".csv">
            <button type="button" onclick="uploadAttendancePercentageCSV()">Upload CSV</button>
            <button class="button" onclick="downloadAttendancePercentageCSV()">Download the generated File</button>
            <div id="csvAttendancePercentageResult">CSV Result Content Here</div>
        </div>
    </main>
        <!-- HTML end -->
    <script>
        // JavaScript begin
document.addEventListener('DOMContentLoaded', function() {
    // Display CSV content in csvTextarea1 upon file selection
    var fileInput = document.getElementById('csvFileInput');
    fileInput.addEventListener('change', function() {
        var file = this.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                var lines = content.split('\n');
    
                // Create a Table Element
                var table = document.createElement('table');
                table.setAttribute('border', '1');
    
                // Traverse every Line
                lines.forEach(function(line) {
                    var row = document.createElement('tr'); // Create a Table Line
                    var fields = line.split(','); 
    
                    // Traverse every field
                    fields.forEach(function(field) {
                        var cell = document.createElement('td'); // Create a Tble Data
                        cell.textContent = field; 
                        row.appendChild(cell); // Add cell to current row
                    });
    
                    table.appendChild(row); // Add the current row to the table
                });
    
                // Get the div container used to display the table
                var displayArea = document.getElementById('csvDisplayArea');
                displayArea.innerHTML = ''; // Clear the contents of the container
                displayArea.appendChild(table); // Add the newly created table to the container
    
            };
            reader.readAsText(file);
        }
    });

    // Toggle accordion panels
    window.toggleAccordion = function(sectionId) {
        var panel = document.getElementById(sectionId);
        // Use the data-section attribute to find the specific button for this section
        var arrow = document.querySelector(`button[data-section='${sectionId}'] .arrow`);
    
        // Check if the panel is already open
        if (panel.style.display === "block") {
            panel.style.display = "none";
            // Change the arrow to a right-pointing triangle when the panel is closed
            arrow.innerHTML = "►";
        } else {
            panel.style.display = "block";
            // Change the arrow to a down-pointing triangle when the panel is open
            arrow.innerHTML = "▼";
        }
    }

    displayMatchingElements();
});

function loadCSV() {
    var fileInput = document.getElementById('csvFileInput');
    var file = fileInput.files[0];
    if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var content = e.target.result;
            var lines = content.split('\n');
            // 创建表格并添加标题行
            var table = document.createElement('table');
            table.setAttribute('border', '1');
            var headerRow = document.createElement('tr');
            ['Name', 'Group','Email', 'Date', 'Reason'].forEach(function(header) {
                var th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            // Parse fourth row to get date data
            var dateFields = lines[3].split(',');

            //Start processing student data rows, assuming starting from the fifth row
            for (var i = 4; i < lines.length; i++) {
                var fields = lines[i].split(',');
                var reason = '';

                fields.forEach(function(field, index) {
                    if (field.includes('L (1/2)')) {
                        reason = 'Late';
                    } else if (field.includes('E (1/2)')) {
                        reason = 'Excused';
                    } else if (field.includes('A (0/2)')) {
                        reason = 'Absent';
                    }

                    if (reason) {
                        // Get the date of the corresponding column from the date row and extract the year part
                        var dateMatch = dateFields[index].match(/^(.*?20\d{2})/); // Matches years starting with "20" followed by two digits
                        var year = dateMatch ? dateMatch[0] : ''; // If the match is successful, use the matched year, otherwise use the empty string
                        var tr = document.createElement('tr');
                        var name = fields[0] + ' ' + fields[1]; // firstName + lastName
                        var group = fields[2];
                        var email = fields[5];
                        [name,group, email, year, reason].forEach(function(text) {
                            var td = document.createElement('td');
                            td.textContent = text;
                            tr.appendChild(td);
                        });
                        table.appendChild(tr);
                        reason = '';
                    }
                });
            }

            // Adds a table to the specified <div>
            var displayArea = document.getElementById('csvTextarea2');
            displayArea.innerHTML = ''; // Clear out any old content that may exist
            displayArea.appendChild(table);
        };
        reader.readAsText(file);
    }
}


function downloadCSV() {
    var table = document.getElementById("csvTextarea2").querySelector("table");
    
    // Check if table exists
    if (!table) {
        // If there is no table, use headersInfo to prompt the user
        alert("Please choose your file.");
    } else {
        //Convert table content to CSV format
        var rows = table.querySelectorAll("tr");
        var csvContent = Array.from(rows)
            .map(row => {
                var cells = row.querySelectorAll("th, td");
                return Array.from(cells).map(cell => `"${cell.textContent}"`).join(",");
            })
            .join("\n");

        // Create a hidden a tag for downloading
        var hiddenElement = document.createElement('a');
        hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csvContent);
        hiddenElement.target = '_blank';

        // Provide the downloaded file name, using underscores to replace special characters
        hiddenElement.download = 'Lab_Late_Absent_Excuse.csv';
        document.body.appendChild(hiddenElement);
        hiddenElement.click();
        document.body.removeChild(hiddenElement);
    }
}




document.addEventListener("DOMContentLoaded", function() {
    var mainContent = document.querySelector(".main-content");
    var calculateAverageScoreSection = document.querySelector('.calculate-average-score');
    var calculateGroupAttendanceSection = document.querySelector('.calculategroupattendance');
    var NoHiddenLab =  document.querySelector('.CalculateHiddenLab');
    document.getElementById("showMainContent").addEventListener("click", function() {  
        calculateGroupAttendanceSection.style.display = "none"; 
        calculateAverageScoreSection.style.display = "none"; 
        NoHiddenLab.style.display = "none";  

        if (mainContent.style.display === "none" || mainContent.style.display === "") {
            mainContent.style.display = "block";
        } else {
            mainContent.style.display = "none";
        }
    });

    document.getElementById('toggleScoreArea').addEventListener('click', function() {
        mainContent.style.display = "none";   
        calculateGroupAttendanceSection.style.display = "none";  
        NoHiddenLab.style.display = "none";    

        if (calculateAverageScoreSection.style.display === 'none' || calculateAverageScoreSection.style.display === '') {
            calculateAverageScoreSection.style.display = 'block';
        } else {
            calculateAverageScoreSection.style.display = 'none';
        }
    });
    document.getElementById('showMainContent2').addEventListener('click', function() {
        mainContent.style.display = "none";
        calculateAverageScoreSection.style.display = "none"; 
        NoHiddenLab.style.display = "none"; 

        if (calculateGroupAttendanceSection.style.display === 'none' || calculateGroupAttendanceSection.style.display === '') {
            calculateGroupAttendanceSection.style.display = 'block';
        } else {
            calculateGroupAttendanceSection.style.display = 'none';
        }
    });
    document.getElementById('NotHiddenLab').addEventListener('click', function() {
        mainContent.style.display = "none";
        calculateAverageScoreSection.style.display = "none"; 
        calculateGroupAttendanceSection.style.display = "none";  

        if (NoHiddenLab.style.display === 'none' || NoHiddenLab.style.display === '') {
            NoHiddenLab.style.display = 'block';
        } else {
            NoHiddenLab.style.display = 'none';
        }
    }); 

});

// .................................................................

var fileInput = document.getElementById('uploadClassList');
var fileInput = document.getElementById('uploadClassList2');

// Processing after file selection
fileInput.addEventListener('change', function() {
    // Make sure at least one file is selected
    if (fileInput.files.length > 0) {
        var file = fileInput.files[0]; // Get uploaded files
        var reader = new FileReader();

        reader.onload = function(e) {
            var text = e.target.result;
            var classListCsvJson = csvToJson(text); // Convert CSV text to JSON
            // console.log(classListCsvJson); // 
        };

        // read file content
        reader.readAsText(file);
    } else {
        console.log("No file selected!");
    }
});

function csvToJson(csv) {
    var lines = csv.split("\n");
    var result = [];
    var headers = lines[0].split(",");

    for (var i = 1; i < lines.length; i++) {
        var obj = {};
        var currentline = lines[i].split(",");

        for (var j = 0; j < headers.length; j++) {
            // Check if currentline[j] exists, if not set to empty string
            obj[headers[j].trim()] = currentline[j] ? currentline[j].trim() : "";
        }

        // If the object does not consist entirely of an empty string, add to the result
        if (Object.values(obj).some(value => value !== "")) {
            result.push(obj);
        }
    }

    return result; // Returns an array of JSON objects
}





document.addEventListener('DOMContentLoaded', function() {
    var csvAttendancePercentageInput = document.getElementById('csvAttendancePercentageInput');
    csvAttendancePercentageInput.addEventListener('change', function() {
        var file = this.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                var lines = content.split('\n');

                // Create a new table element
                var table = document.createElement('table');
                table.setAttribute('border', '1');

                // Iterate through each line
                lines.forEach(function(line) {
                    var row = document.createElement('tr'); // Create a new tr element
                    var fields = line.split(','); // Split each line by comma

                    // Iterate through each field
                    fields.forEach(function(field) {
                        var cell = document.createElement('td'); // Create a new td element
                        cell.textContent = field; // Set cell content
                        row.appendChild(cell); // Add the cell to the current row
                    });

                    table.appendChild(row); // Add the current row to the table
                });

                // Get the div container for displaying the table
                var displayArea = document.getElementById('csvAttendancePercentageDisplay');
                displayArea.innerHTML = ''; // Clear any existing content in the container
                displayArea.appendChild(table); // Add the new table to the container
            };
            reader.readAsText(file);
        }
    });
});



document.getElementById('csvAttendancePercentageInput').addEventListener('change', function(event) {
    const fileReader = new FileReader();
    fileReader.onload = function(fileLoadedEvent) {
        const text = fileLoadedEvent.target.result;
        document.getElementById('csvAttendancePercentageDisplay').textContent = text;
        document.getElementById('csvAttendancePercentageResult').style.display = 'none';
        processCSVData(text);
    };
    fileReader.readAsText(event.target.files[0], "UTF-8");
});

function processCSVData(csvData) {
    const lines = csvData.split('\n');
    let totalEligibleStudents = 0;
    let studentsWith100Percent = 0;
    let totalExcludingSpecial = 0;
    let studentsWith100PercentEx = 0;
    const groupTotalStudents = {};
    const groupStudentsWith100Percent = {};

    // Determine the index of the "Percentage" column
    const headerColumns = lines[3].split(','); // Assume the fourth row is the title row
    const percentageColumnIndex = headerColumns.findIndex(col => col.trim() === "Percentage");

    if (percentageColumnIndex === -1) {
        console.error("Percentage column not found.");
        return;
    }

    lines.slice(4).forEach((line) => { //Start reading from data row
        const columns = line.split(',');
        if (columns.length > percentageColumnIndex) {
            totalEligibleStudents++;
            const attendancePercentageStr = columns[percentageColumnIndex].trim();
            const has100Percent = "100" === attendancePercentageStr;

            if (has100Percent) {
                studentsWith100Percent++;
            }

            const groups = columns[2].trim(); // Assume that the grouping information is still in the third column
            const isExcludedGroup = groups.includes("Demonstrator") || groups.includes("CSC Tutors") || groups === "" || groups.includes("0");

            if (!isExcludedGroup) {
                totalExcludingSpecial++;
                if (has100Percent) {
                    studentsWith100PercentEx++;
                }
            }

            const groupsArray = groups.split(',');
            if (groupsArray.length > 0) {
                const firstGroup = groupsArray[0].trim();
                if (["Red", "Blue", "Yellow", "Green"].includes(firstGroup)) {
                    groupTotalStudents[firstGroup] = (groupTotalStudents[firstGroup] || 0) + 1;
                    if (has100Percent) {
                        groupStudentsWith100Percent[firstGroup] = (groupStudentsWith100Percent[firstGroup] || 0) + 1;
                        
                    }
                }
            }
        }
    });


    // Start building table HTML
    let tableHTML = '<table border="1"><tr><th>Groups</th><th>Percentage</th></tr>';
    
    // Add 100% attendance rate for all members
    tableHTML += `<tr><td>All Eligible Members and Demons with 100% Attendance</td><td>${((studentsWith100Percent / totalEligibleStudents) * 100).toFixed(2)}%</td></tr>`;
    
    // Add members with 100% attendance except specific group
    tableHTML += `<tr><td>All Eligible Students Excluding 'Demonstrator', 'CSC Tutors', and Blank Groups with 100% Attendance</td><td>${((studentsWith100PercentEx / totalExcludingSpecial) * 100).toFixed(2)}%</td></tr>`;
    
    // Add rows for each specific group
    ["Red", "Blue", "Yellow", "Green"].forEach(group => {
        const totalInGroup = groupTotalStudents[group] || 0;
        const with100InGroup = groupStudentsWith100Percent[group] || 0;
        const percentageWith100 = ((with100InGroup / totalInGroup) * 100).toFixed(2);
        tableHTML += `<tr><td>Eligible Students in Group ${group} with 100% Attendance</td><td>${percentageWith100}%</td></tr>`;
    });
    
    // Complete table HTML construction
    tableHTML += '</table>';

    // Set table HTML to results area
    document.getElementById('csvAttendancePercentageResult').innerHTML = tableHTML;
}


function uploadAttendancePercentageCSV() {
    document.getElementById('csvAttendancePercentageResult').style.display = 'block';
}

function downloadAttendancePercentageCSV() {
    // Check if the file has been selected
    const fileInput = document.getElementById('csvAttendancePercentageInput');
    if (!fileInput.files.length) {
        // Show alert if no file is selected
        alert('Please choose your file.');
        return; // Return early without executing subsequent code
    }

    //If the file has been selected, continue to execute the original download logic
    const data = document.getElementById('csvAttendancePercentageResult').textContent;
    if (!data) {
        // Also displays an alert if there is no data (i.e. the user did not click "Upload CSV")
        alert('Please upload your file first.');
        return;
    }

    const blob = new Blob([data], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.download = 'Group_Attendance_Percentage_Result.csv';
    link.href = url;
    document.body.appendChild(link); 
    link.click(); 
    document.body.removeChild(link); 
}




//***************************************************************************************************************************** */

// Define two arrays to store data for specific columns
var classListFifthColumn = [];
var labInfoSecondColumn = [];

// Input Class List in left textbox
document.getElementById('uploadClassList').addEventListener('change', function(e) {
    var file = e.target.files[0];
    var reader = new FileReader();
    
    reader.onload = function(e) {
        var contents = e.target.result;
        var lines = contents.split('\n');
        var table = '<table border="1">';

        classListFifthColumn = []; // Clear array to store new data
        
        lines.forEach(function(line, index) {
            var values = line.split(',');
            if (values.length < 5) { // Make sure each row has at least 5 columns
                return; 
            }

            if (index === 0) { // title row
                // Use <th> tag for title row and apply bold style
                table += '<tr>' + values.map(function(header) {
                    return '<th><strong>' + header.trim() + '</strong></th>';
                }).join('') + '</tr>';
            } else {
                table += '<tr>';
                
                values.forEach(function(value, colIndex) {
                    if (colIndex === 4) { // fifth row，indexis 4
                        // Store the data from the fifth column, ignoring case and removing spaces
                        classListFifthColumn.push(value.trim().toLowerCase());
                    }
                    table += '<td>' + value + '</td>';
                });
                
                table += '</tr>';
            }
        });
        
        table += '</table>';
        document.getElementById('classListArea').innerHTML = table; // display result table
    };
    
    reader.readAsText(file); 
});


// To define a mapping that stores each email in labInfo with its corresponding row of data,
var labInfoRowsByEmail = {};
// Define an array to store the length of each column header
var headersInfo = [];

// Input Lab Info in right textbox
document.getElementById('uploadLabInfo').addEventListener('change', function(e) {
    var file = e.target.files[0];
    var reader = new FileReader();
    
    reader.onload = function(e) {
        var contents = e.target.result;
        var lines = contents.split('\n');
        var table = '<table border="1">';

        labInfoRowsByEmail = {}; // empty mappingg
        labInfoSecondColumn = []; // empty array to store new data
        headersInfo = []; // 
        
        lines.forEach(function(line, index) {
            var values = line.split(',');

                if (index === 0) { 
                    headersInfo = values.map(value => 
                        ({ name: value.trim(), length: value.trim().length, scoreCount : 0 })
                    );
                    table += '<tr><th>' + values.map(value =>  
                        '<strong>' + value.trim() + '</strong>'
                    ).join('</th><th>') + '</th></tr>';
                } else if (values.length > 1) { // make sure a row has at least 2 columns
                    // Store the entire row of data in the map, with the second column (email) as the key
                    var email = values[1].trim().toLowerCase();
                    labInfoRowsByEmail[email] = values;
                    
                    table += '<tr>';
                    values.forEach(function(value, colIndex) {
                        if (colIndex === 1) { // seond column，index is 1
                            labInfoSecondColumn.push(email); // Store the data in the second column, ignoring case and removing spaces
                        }
                        table += '<td>' + value + '</td>';
                    });
                    table += '</tr>';
                }
            
        });
        
        table += '</table>';
        document.getElementById('labInfoArea').innerHTML = table;
    };
    
    reader.readAsText(file);
});


document.getElementById('calculateAvgScore').addEventListener('click', function() {
    displayMatchingElements();
});

function displayMatchingElements() {
    var selectedMultiplier = parseFloat(document.querySelector('input[name="multiplier"]:checked').value);
    var displayContent = `<b>Colored labs accounted for ${selectedMultiplier} Times</b><br><br>`;
    displayContent += '<table border="1"><tr><th>Email</th><th>Weighted Score</th></tr>';

    classListFifthColumn.forEach(email => {
        if (labInfoSecondColumn.includes(email)) {
            var rowData = labInfoRowsByEmail[email];
            var actualScore = 0;
            var totalPossibleScore = 0;
            var columnsWithLessThan10 = 0;
            var columnsWith10OrMore = 0;

            headersInfo.slice(2).forEach((header, index) => {
                var cellValue = rowData[index + 2].trim(); // Adjust index for actual data in rowData
                var score = parseFloat(cellValue) || 0; // Treat non-numeric and empty as 0
                var weight = header.name.length >= 10 ? selectedMultiplier : 1;

                if (header.name.length < 10) {
                    columnsWithLessThan10 += 1; // Count columns with title length less than 10
                } else {
                    columnsWith10OrMore += 1; // Count columns with title length 10 or more
                    totalPossibleScore += 100 * weight; // Add weighted full score for columns with 10 or more
                }

                actualScore += score * weight;
            });

            // Calculate total possible score based on your criteria
            totalPossibleScore += columnsWithLessThan10 * 100; // Add full score for columns with title length less than 10
            totalPossibleScore += (2 - columnsWith10OrMore) * 100 * selectedMultiplier; // Adjust for missing scores in columns with 10 or more

            var weightedScore = (actualScore / totalPossibleScore) * 100;
            displayContent += `<tr><td>${email}</td><td>${weightedScore.toFixed(2)}%</td></tr>`;
        }
    });

    displayContent += '</table>';
    document.getElementById('avgScoreDisplayArea').innerHTML = displayContent;
}



document.getElementById('downloadaverageResult').addEventListener('click', function() {
    var avgScoreArea = document.getElementById('avgScoreDisplayArea').innerHTML;
    
    // Check if the avgScoreDisplayArea only contains the default message and table headers
    if (!avgScoreArea.includes('<tr><td>') || avgScoreArea.includes('Colored labs accounted for 1.5 Times') && !avgScoreArea.includes('</td></tr><tr><td>')) {
        alert('Please choose your file.');
        return; // Exit the function early if only the initial message and headers are present
    }
    
    var table = document.getElementById('avgScoreDisplayArea').getElementsByTagName('table')[0];
    var csvContent = "data:text/csv;charset=utf-8,";
    
    // Loop through each row of the table
    for (var i = 0, row; row = table.rows[i]; i++) {
        // Loop through each cell of the row
        for (var j = 0, col; col = row.cells[j]; j++) {
            // Add cell content to CSV string, separated by commas
            csvContent += '"' + col.innerText.replace(/"/g, '""') + '"' + (j < row.cells.length - 1 ? ',' : '');
        }
        // Add a newline at the end of each row
        csvContent += "\n";
    }
    
    // Encode the CSV content and create a download link
    var encodedUri = encodeURI(csvContent);
    var link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Average_Scores.csv");
    document.body.appendChild(link);
    link.click(); // Trigger the download
    document.body.removeChild(link); // Clean up by removing the link element
});







//***************************************************************************************************************************** */

let classEmails = []; // Store emails from the Classlist
let labData = []; // Store rows from LabCSV for comparison
function readClasslistCsv(inputId) {
    document.getElementById(inputId).addEventListener('change', function() {
        var file = this.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                classEmails = []; // Reset for each new file
                var content = e.target.result;
                var lines = content.split('\n');
                lines.slice(1).forEach(line => {
                    var columns = line.split(',');
                    if (columns.length >= 5) {
                        var email = columns[4].trim().toLowerCase();
                        if (email) {
                            classEmails.push(email);
                        }
                    }
                });
            };
            reader.readAsText(file);
        }
    });
}
let labHeader = ""; // Variable to store the header of the LabCSV

function readLabCsv(inputId) {
    document.getElementById(inputId).addEventListener('change', function() {
        var file = this.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                labData = []; // Reset for each new file
                labHeader = ""; // Reset the header for the new file
                var content = e.target.result;
                var lines = content.split('\n');

                // Check if there's at least one line for the header
                if (lines.length > 0) {
                    labHeader = lines[0]; // Store the first line as the header
                    lines.slice(1).forEach(line => {
                        var columns = line.split(',');
                        if (columns.length >= 2) {
                            var username = columns[1].trim().toLowerCase();
                            labData.push({username: username, rowData: line});
                        }
                    });
                }
            };
            reader.readAsText(file);
        }
    });
}

function calculateAndDisplayHiddenLab() {
    // Filter to find matching lab data based on class emails
    let matchingLabData = labData.filter(row => classEmails.includes(row.username));

    // Further filter to identify students missing special question completions
    let missingSpecials = matchingLabData.filter(row => {
        const answers = row.rowData.split(',');
        const colorCompletion = {}; // Tracks completion count for each color

        // Iterate through answers to find and count completed special questions by color
        answers.forEach((answer, index) => {
            const match = labHeader.split(',')[index].match(/(\d+_l\d+q\d+)-(\w+)/);
            if (match) {
                const color = match[2];
                colorCompletion[color] = colorCompletion[color] || 0;
                // Assuming a non-empty answer indicates completion
                if (answer.trim() !== '') {
                    colorCompletion[color]++;
                }
            }
        });

        // Check if any color has 2 or more completions for each student
        return !Object.values(colorCompletion).some(count => count >= 2);
    });

    // Display Logic for missing specials
    var displayArea = document.getElementById('csvhiddenDisplay');
    displayArea.innerHTML = ''; // Clear previous contents

    var table = document.createElement('table');
    table.setAttribute('border', '1');

    // Create header row from stored `labHeader`
    var headers = labHeader.split(',');
    var thead = table.createTHead();
    var headerRow = thead.insertRow();
    headers.forEach(header => {
        var th = document.createElement('th');
        th.textContent = header.trim();
        headerRow.appendChild(th);
    });

    // Check and append data rows for students missing special questions
    var tbody = table.createTBody();
    if (missingSpecials.length > 0) {
        missingSpecials.forEach(item => {
            var tr = tbody.insertRow();
            item.rowData.split(',').forEach(cellData => {
                var td = tr.insertCell();
                td.textContent = cellData.trim();
            });
        });
    } else {
        // Display a message if no students are missing special questions
        var tr = tbody.insertRow();
        var td = tr.insertCell();
        td.setAttribute('colspan', headers.length);
        td.textContent = "All students have completed the required special questions.";
        td.style.textAlign = 'center';
    }

    displayArea.appendChild(table);
}



document.getElementById('calculateHiddenlab').addEventListener('click', calculateAndDisplayHiddenLab);


document.addEventListener('DOMContentLoaded', function() {
    readClasslistCsv('uploadClassList2');
    readLabCsv('uploadLabInfo2');
    // The 'calculateAndDisplayHiddenLab' function is already bound to the button click event
});

// This example assumes 'classEmails' and 'labData' are already populated with the necessary data from your CSV files.
// You'll need to implement or adjust the CSV file reading and parsing logic to populate these variables accordingly.

// This is a simplified demonstration. You'll need to integrate CSV file reading and data extraction
// to fill 'classEmails' and 'labUsernames' with actual data from your uploaded CSV files.


function setupCSVTableDisplay(inputId, displayAreaId) {
    document.getElementById(inputId).addEventListener('change', function() {
        var file = this.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                var lines = content.split('\n');

                // Create a Table Element with a border attribute for framing
                var table = document.createElement('table');
                table.setAttribute('border', '1');

                // Traverse every Line
                lines.forEach(function(line, index) {
                    var row = document.createElement('tr'); // Create a Table Row
                    var fields = line.split(',');

                    // Traverse every field
                    fields.forEach(function(field) {
                        var cell;
                        // Use 'th' for the header row, 'td' for other rows
                        if (index === 0) {
                            cell = document.createElement('th');
                        } else {
                            cell = document.createElement('td');
                        }
                        cell.textContent = field.trim();
                        row.appendChild(cell); // Add the cell to the current row
                    });

                    table.appendChild(row); // Add the current row to the table
                });

                // Get the container for displaying the table
                var displayArea = document.getElementById(displayAreaId);
                displayArea.innerHTML = ''; // Clear the container's content
                displayArea.appendChild(table); // Add the newly created table to the container
            };
            reader.readAsText(file);
        }
    });
}

// Initialize the file upload handlers upon document content fully loaded
document.addEventListener('DOMContentLoaded', function() {
    setupCSVTableDisplay('uploadClassList2', 'classListArea2');
    setupCSVTableDisplay('uploadLabInfo2', 'labInfoArea2');
});



// Add this function to your existing code
function downloadResultsAsCSV() {
    let csvContent = "data:text/csv;charset=utf-8,";

    // Assuming you're converting directly from the displayed table
    const table = document.querySelector('#csvhiddenDisplay table');
    if (table) {
        // Iterate over rows
        Array.from(table.rows).forEach(row => {
            const rowData = Array.from(row.cells)
                .map(cell => `"${cell.textContent}"`) // Wrap each cell text in double quotes
                .join(','); // Join each cell to form a row
            csvContent += rowData + "\r\n"; // Add a newline at the end of each row
        });

        // Encode the CSV content
        const encodedUri = encodeURI(csvContent);

        // Create a temporary link to trigger the download
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "Missing_Hidden_Lab.csv"); // Name the file here
        document.body.appendChild(link); // Required for Firefox

        link.click(); // Trigger the download
        document.body.removeChild(link); // Clean up
    } else {
        alert("Please choose you file.");
    }
}

// Bind the download function to the button's click event
document.getElementById('downloadHiddenlab').addEventListener('click', downloadResultsAsCSV);


                // JavaScript end
    </script>
</body>
</html>

